---
title: 가상메모리와 페이지폴트
date: 2017-09-01 13:37:31
categories: devops
---

프로그램이 동작하기 위해서는 컴퓨터의 하드웨어 자원을 필요로 한다. 프로그램에서 필요한 연산을 하기 위해서는 CPU가 프로그램의 동작을 제어하는 중에 필요한 데이터를 다루기 위해 메모리라는 물리적인 공간이 필요하기도 하다.

<!--more-->

## 프로세스와 가상 메모리

프로그램은 위와 같이 컴퓨터의 자원을 효율적으로 다루기 위해 프로세스를 생성하게 되는데 모든 프로세스는 자신만의 가상 주소 공간을 가지고 있다. 예를 들어 32bit를 기반으로한 프로세스는 최대 4GB의 주소 공간을 가질 수 있다.

하나의 프로세스에는 다양한 쓰레드가 생성되고 소멸되는데 쓰레드가 수행되면서 메모리를 활용할 때 자신을 생성한 프로세스가 소유하고 있는 메모리에만 접근이 가능하다. 다른 프로세스에 의해 소유된 메모리는 숨겨져 있으며 접근이 불가능하다.

예를 들면 운영체제가 점유하고 있는 메모리에 대한 참조는 외부의 프로세스로부터 숨겨져있다고 할 수 있는데 특정 프로세스에 존재하는 쓰레드가 운영체제의 데이터에 접근하는 것이 불가능함을 의미한다.

하지만 A라는 프로세스가 0x12345678 주소에 데이터를 저장하고 B라는 프로세스 역시 0x12345678 주소에 데이터를 저장할 수 있는데 이 주소들은 사실 물리적으로 독립되어 있는 상태이다.

가상 메모리는 프로세스간에 물리적으로 메모리를 공유할 수 없는 장점을 취하면서 메모리 주소를 중복되지 않도록 많은 내용을 고려하지 않기 위해 프로세스의 `논리적인 메모리`와 `물리적인 메모리`를 분리하기 위해 생겨난 것이라 할 수 있다.

## 가상 메모리가 필요하게 되는 이유

우리는 동시에 여러 프로그램을 실행하는 경우가 많다. 하지만 운영체제에 이미 많은 양의 메모리를 점유되어 있고 이러한 물리적인 한계를 극복하기 위한 방법으로 가상 메모리를 활용할 수 있다.

가상메모리는 물리적인 메모리의 크기보다 많은 공간을 사용할 수 있게 도와준다. 예를 들면 하나의 프로세스의 논리적인 메모리의 크기가 물리적 메모리 크기보다 커지는 것도 가능하며 우리가 운영체제에서 동시에 사용하는 다양한 프로그램의 프로세스의 메모리 크기의 총합이 물리적 메모리의 크기보다 클 수도 있다는 점이다.

정리하면 한정된 물리적 메모리 공간의 한계를 극복하고자 디스크와 같은 느린 저장 장치를 활용해 애플리케이션들이 더 많은 메모리를 활용할 수 있게 해 주는 것이 가상 메모리이다.

가상 메모리를 구현하기 위해서는 컴퓨터가 특수 메모리 관리 하드웨어를 갖추고 있어야만 한다. 이 하드웨어는 종종 MMU (Memory Management Unit)라고 부르기도 하는데. MMU가 없이는 CPU가 RAM에 접근할때 실제 RAM의 위치가 절대 변경되지 않기 때문에 메모리 주소 123은 RAM에서도 동일한 물리적 주소를 갖게된다.

그러나 MMU를 사용하는 경우 각 메모리에 접근하기 이전에 메모리 주소 번역 작업을 수행한다. 즉 메모리 주소 123가 한번은 물리적 주소 82043으로 지정되었다가 다음엔 물리적 주소 20468로 지정될 수 있다는 것을 의미한다. 그러나 수억만 바이트에 이르는 메모리를 하나씩 가상 주소에서 물리적 주소로 번역하게되면 작업 부하가 너무 높아지므로, MMU는 RAM을 여러 부분 — 페이지(pages)로 나누어 각 페이지를 하나의 독립된 항목으로 처리한다.

## 페이지

가상 메모리를 논리적으로 작동시키기 위해 메모리를 사용하는 최소 단위의 크기를 정의한게 페이지 단위이다. 최근의 대부분의 운영체제는 4KB의 크기의 페이지를 사용하며 페이지의 주소 공간을 참조하는 페이지 테이블에 의해서 가상 메모리에 대응하는 물리적 주소를 찾아낸다.

<img src='http://www.programering.com/images/remote/ZnJvbT1jaGluYXVuaXgmdXJsPWNtYnc1U1ppSm5Nell6TTFJRE56a3pNeDhWTnlFak55Y2pOeThpTnk4aU13UVRNd0l6TDA1V1p0aDJZaFJIZGg5Q2RsNW1MNGxtYjFGbWJwaDJZdWMyYnNKMkx2b0RjMFJIYQ.jpg' />

위의 그림에서 보듯이 페이지 테이블에는 비트하나를 두고 해당 페이지가 실제 물리적인 메모리에 있으면 `1` 디스크를 통해 가상 메모리로 할당했다면 `0`으로 valid 값을 저장하고 있다.

## 페이지 폴트

페이지 폴트란 프로그램이 자신의 주소 공간에는 존재하지만 시스템의 RAM에는 현재 없는 데이터나 코드에 접근 시도하였을 경우 발생하는 현상을 말한다. 페이지 폴트가 발생하면 운영체제는 그 데이터를 메모리로 가져와서 마치 페이지 폴트가 전혀 발생하지 않은 것처럼 프로그램이 계속 작동하도록 한다.













